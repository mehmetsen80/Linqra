version: '3.8'

networks:
  linqra-network:
    external: true

services:
  minio:
    build:
      context: .
      dockerfile: .kube/minio/Dockerfile.polaris
    container_name: minio-service
    restart: always
    ports:
      - "9000:9000"
      - "9001:9001"
    environment:
      VAULT_MASTER_KEY: ${VAULT_MASTER_KEY}
      VAULT_ENVIRONMENT: ${VAULT_ENVIRONMENT:-ec2}
      VAULT_REQUIRED_VARS: MINIO_ACCESS_KEY,MINIO_SECRET_KEY
      MINIO_BROWSER_REDIRECT_URL: "https://polaris.linqra.com/minio/"
    volumes:
      - /opt/minio/data:/data
      - ./secrets:/app/secrets:ro
    networks:
      - linqra-network

  createbuckets:
    build:
      context: .
      dockerfile: .kube/minio/Dockerfile.polaris
    container_name: minio-createbuckets
    depends_on:
      - minio
    environment:
      VAULT_MASTER_KEY: ${VAULT_MASTER_KEY}
      VAULT_ENVIRONMENT: ${VAULT_ENVIRONMENT:-ec2}
      VAULT_REQUIRED_VARS: MINIO_ACCESS_KEY,MINIO_SECRET_KEY
    # We override entrypoint to use our shell command, mostly to bypass the default server startup
    # But we MUST use /app/vault-entrypoint.sh to inject secrets first!
    # vault-entrypoint.sh executes the passed arguments.
    entrypoint:
      - /app/vault-entrypoint.sh
      - /bin/sh
      - -c
    command: >
      " echo 'Waiting for MinIO to be ready...'; # Simple wait loop sleep 10;

      echo 'Configuring MinIO Client...'; # Use injected env vars MINIO_ACCESS_KEY / MINIO_SECRET_KEY mc config host add myminio http://minio-service:9000 $${MINIO_ACCESS_KEY} $${MINIO_SECRET_KEY};

      echo 'Creating Bucket linqra-knowledge-hub...'; mc mb --ignore-existing myminio/linqra-knowledge-hub;

      echo 'Setting Public Download Policy...'; mc anonymous set download myminio/linqra-knowledge-hub;

      echo 'Bucket created successfully!'; "
    volumes:
      - ./secrets:/app/secrets:ro
    networks:
      - linqra-network
