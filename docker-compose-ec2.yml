networks:
  linqra-network:
    external: true
    driver_opts:
      com.docker.network.driver.mtu: 1500

services:
  #   # postgres
  #   postgres-service:
  #     build:
  #       context: .
  #       dockerfile: ./.kube/postgres/Dockerfile
  #     container_name: postgres-service
  #     command: postgres -c "max_connections=200"
  #     restart: always
  #     ports:
  #       - "5432:5432"
  #     healthcheck:
  #       test: [ "CMD-SHELL", "pg_isready -U $$POSTGRES_USER -d $$POSTGRES_DB" ]
  #       interval: 10s
  #       timeout: 3s
  #       retries: 3
  #     volumes:
  #       - ./.kube/postgres/data/:/var/lib/postgresql/pgdata
  #       - ./secrets:/app/secrets:ro
  #     environment:
  #       VAULT_MASTER_KEY: ${VAULT_MASTER_KEY}
  #       VAULT_ENVIRONMENT: ${VAULT_ENVIRONMENT:-ec2}
  #       VAULT_REQUIRED_VARS: POSTGRES_DB,POSTGRES_USER,POSTGRES_PASSWORD
  #     networks:
  #       - linqra-network
  #
  #   # postgres admin
  #   pgadmin-service:
  #     build:
  #       context: .
  #       dockerfile: ./.kube/pgadmin/Dockerfile
  #     restart: always
  #     ports:
  #       - "9090:80"
  #     environment:
  #       PGADMIN_DEFAULT_EMAIL: user-name@domain-name.com
  #       PGADMIN_DEFAULT_PASSWORD: strong-password
  #     volumes:
  #       - ./.kube/pgadmin/data/:/var/lib/pgadmin
  #     networks:
  #       - linqra-network

  #   # keycloak
  #   keycloak-service:
  #     build:
  #       context: .
  #       dockerfile: ./.kube/keycloak/Dockerfile
  #     environment:
  #       KC_DB: postgres
  #       KC_HTTP_ENABLED: true
  #       KC_HTTP_PORT: 8080
  #       KC_HTTP_RELATIVE_PATH: /keycloak
  #
  #       KC_HOSTNAME: https://linqra.com
  #       KC_HOSTNAME_STRICT: true
  #       KC_HOSTNAME_STRICT_HTTPS: true
  #       KC_HOSTNAME_ADMIN: https://linqra.com/keycloak
  #       KC_HOSTNAME_URL: https://linqra.com/keycloak
  #       KC_FRONTEND_URL: https://linqra.com/keycloak
  #
  #       KC_PROXY: edge
  #       PROXY_ADDRESS_FORWARDING: true
  #
  #       KC_LOG_LEVEL: info
  #       KC_METRICS_ENABLED: true
  #       KC_HEALTH_ENABLED: true
  #       KC_FEATURES: admin
  #
  #       KC_SPI_RESOURCES_PUBLIC_URL: https://linqra.com/keycloak/resources
  #       KC_SPI_LOGIN_PROTOCOL_OPENID_CONNECT_REDIRECT_HOSTNAME: https://linqra.com/keycloak
  #       KC_SPI_LOGIN_PROTOCOL_OPENID_CONNECT_LEGACY_IFRAME_COMPATIBLE: "true"
  #       KC_SPI_LOGIN_PROTOCOL_OPENID_CONNECT_SUPPRESS_LOGOUT_CONFIRMATION_SCREEN: "true"
  #       VAULT_MASTER_KEY: ${VAULT_MASTER_KEY}
  #       VAULT_ENVIRONMENT: ${VAULT_ENVIRONMENT:-ec2}
  #       VAULT_REQUIRED_VARS: POSTGRES_DB,POSTGRES_USER,POSTGRES_PASSWORD,KEYCLOAK_ADMIN,KEYCLOAK_ADMIN_PASSWORD
  #
  #     command:
  #       - start
  #     volumes:
  #       - ./.kube/keycloak/data/import:/opt/keycloak/data/import
  #       - ./.kube/keycloak/data/export:/opt/keycloak/data/export
  #       - ./.kube/keycloak/themes:/opt/keycloak/themes
  #       - ./secrets:/app/secrets:ro
  #     depends_on:
  #       postgres-service:
  #         condition: service_healthy
  #     healthcheck:
  #       test: [ "CMD", "curl", "-f", "-H", "Host: localhost", "http://localhost:8080/health/ready" ]
  #       interval: 10s
  #       timeout: 3s
  #       retries: 3
  #     ports:
  #       - "8281:8080"
  #     networks:
  #       - linqra-network

  # Discovery Server (Eureka)
  discovery-service:
    build:
      context: .
      dockerfile: .kube/eureka/Dockerfile
    environment:
      VAULT_ENVIRONMENT: ${VAULT_ENVIRONMENT:-ec2}
      VAULT_MASTER_KEY: ${VAULT_MASTER_KEY}
    ports:
      - "8761:8761"
    volumes:
      - ./discovery-server:/app/discovery-server
      - ./keys:/app/keys
      - ./secrets:/app/secrets:ro
    networks:
      - linqra-network

  # Load Balancer
  gateway-loadbalancer:
    image: haproxy:2.8
    ports:
      - "7777:7777"
    volumes:
      - ./.kube/gateway/haproxy.cfg:/usr/local/etc/haproxy/haproxy.cfg:ro
      - ./keys/haproxy/gateway-combined-container.pem:/etc/ssl/gateway-cert.pem:ro
    networks:
      - linqra-network
    depends_on:
      - api-gateway-service

  # API Gateway Service
  api-gateway-service:
    build:
      context: .
      dockerfile: ./.kube/gateway/Dockerfile
    environment:
      VAULT_ENVIRONMENT: ${VAULT_ENVIRONMENT:-ec2}
      VAULT_MASTER_KEY: ${VAULT_MASTER_KEY}
      VAULT_REQUIRED_VARS: SPRING_PROFILES_ACTIVE,AWS_ACCESS_KEY_ID,AWS_SECRET_ACCESS_KEY,GATEWAY_TRUSTSTORE_PASSWORD
    volumes:
      - ./keys:/app/keys
      - ./secrets:/app/secrets:ro
      # Mount data directories for backup scheduler access (read-write for backups)
      - ./.kube:/var/www/linqra/.kube
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '1.0'
          memory: 1G
      replicas: 1
      restart_policy:
        condition: on-failure
    expose:
      - "7777"
    networks:
      - linqra-network
    depends_on:
      - discovery-service
