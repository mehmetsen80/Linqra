name: Deploy Keycloak to Polaris

on:
  workflow_dispatch:

jobs:
  deploy-keycloak:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Create secrets.json from GitHub secret
        env:
          SECRETS_JSON: ${{ secrets.SECRETS_JSON }}
        run: |
          mkdir -p secrets
          
          # Check if SECRETS_JSON secret is provided
          if [ -z "$SECRETS_JSON" ]; then
            echo "ERROR: SECRETS_JSON GitHub secret is not set"
            exit 1
          fi
          
          # Write the JSON secret to file
          echo "$SECRETS_JSON" > secrets/secrets.json
          echo "âœ… secrets.json created"

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Generate vault.encrypted
        env:
          VAULT_MASTER_KEY: ${{ secrets.VAULT_MASTER_KEY }}
        run: |
          # Require VAULT_MASTER_KEY to be set in GitHub secrets
          if [ -z "$VAULT_MASTER_KEY" ]; then
            echo "âŒ ERROR: VAULT_MASTER_KEY secret is not set"
            exit 1
          fi
          
          # Run bootstrap script to create vault
          export VAULT_ENVIRONMENT=ec2
          chmod +x scripts/bootstrap-vault.sh
          bash scripts/bootstrap-vault.sh secrets/secrets.json ec2
          
          # Verify vault file was created
          if [ ! -f secrets/vault.encrypted ]; then
            echo "ERROR: vault.encrypted was not created"
            exit 1
          fi
          
          echo "âœ… vault.encrypted created successfully"

      - name: Install SSH key
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.EC2_SSH_KEY_PROD }}

      - name: Deploy to Polaris EC2
        env:
          EC2_HOST: ${{ secrets.HOST_DNS_POLARIS }}
          EC2_USERNAME: ${{ secrets.USERNAME_PROD }}
          TARGET_DIR: ${{ secrets.TARGET_DIR_PROD }}
          VAULT_MASTER_KEY: ${{ secrets.VAULT_MASTER_KEY }}
        run: |
          # Disable strict host key checking
          mkdir -p ~/.ssh
          echo "StrictHostKeyChecking no" >> ~/.ssh/config

          echo "ðŸš€ Starting Deployment to $EC2_HOST..."

          # Create directory structure
          ssh $EC2_USERNAME@$EC2_HOST "sudo mkdir -p $TARGET_DIR/.kube/keycloak && sudo mkdir -p $TARGET_DIR/.kube/postgres && sudo mkdir -p $TARGET_DIR/vault-reader && sudo mkdir -p $TARGET_DIR/secrets && sudo chown -R $EC2_USERNAME:$EC2_USERNAME $TARGET_DIR"

          # Upload Build Dependencies (Context for Docker build)
          rsync -avz pom.xml $EC2_USERNAME@$EC2_HOST:$TARGET_DIR/
          rsync -avz --delete vault-reader/ $EC2_USERNAME@$EC2_HOST:$TARGET_DIR/vault-reader/
          rsync -avz --delete scripts/ $EC2_USERNAME@$EC2_HOST:$TARGET_DIR/scripts/

          # Upload Keycloak & Postgres Configs (Protect data, exclude default Dockerfile)
          rsync -avz --delete --exclude 'data/' --exclude 'Dockerfile' .kube/keycloak/ $EC2_USERNAME@$EC2_HOST:$TARGET_DIR/.kube/keycloak/
          rsync -avz --delete --exclude 'data/' --exclude 'Dockerfile' .kube/postgres/ $EC2_USERNAME@$EC2_HOST:$TARGET_DIR/.kube/postgres/

          # Upload Docker Compose (Keep specific filename)
          scp docker-compose-polaris-keycloak.yml $EC2_USERNAME@$EC2_HOST:$TARGET_DIR/docker-compose-polaris-keycloak.yml

          # Upload Secrets
          scp secrets/vault.encrypted $EC2_USERNAME@$EC2_HOST:$TARGET_DIR/secrets/

          # Set Env Vars & Run
          echo "ðŸš€ Executing Remote Docker Build..."
          ssh $EC2_USERNAME@$EC2_HOST "
            cd $TARGET_DIR
            
            # Setup Permissions
            sudo chown -R ubuntu:ubuntu $TARGET_DIR
            sudo chmod +x scripts/*.sh

            # Create data dirs if missing (Persisted volumes)
            mkdir -p .kube/postgres/data
            mkdir -p .kube/keycloak/data
            mkdir -p .kube/keycloak/themes

            # Set Secrets Permissions
            sudo chmod 644 secrets/vault.encrypted

            # Export Master Key
            export VAULT_MASTER_KEY=$VAULT_MASTER_KEY
            export VAULT_ENVIRONMENT=ec2

            # Deploy
            sudo -E docker compose -f docker-compose-polaris-keycloak.yml down --remove-orphans || true
            sudo -E docker compose -f docker-compose-polaris-keycloak.yml up -d --build
          "
          echo "âœ… Deployment Complete!"
