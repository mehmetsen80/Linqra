name: Linqra CI

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]

permissions:
  contents: write

jobs:
  java-build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: maven
      - name: Build with Maven
        run: mvn -B package --file pom.xml
      
      # Upload Java artifacts
      - name: Upload Java artifacts
        uses: actions/upload-artifact@v4
        with:
          name: java-artifacts
          path: api-gateway/target/*.jar

      # Upload Discovery Server artifacts
      - name: Upload Discovery Server artifacts
        uses: actions/upload-artifact@v4
        with:
          name: discovery-server-artifacts
          path: discovery-server/target/*.jar

      # Upload docker-compose.yml
      - name: Upload docker-compose file
        uses: actions/upload-artifact@v4
        with:
          name: docker-compose
          path: docker-compose.yml

      # Add this new step to upload .kube directory
      - name: Upload .kube directory
        uses: actions/upload-artifact@v4
        with:
          name: kube-config
          path: .kube/

      # Add this new step to upload keys directory
      - name: Upload keys directory
        uses: actions/upload-artifact@v4
        with:
          name: keys-config
          path: keys/

  react-build:
    needs: java-build
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./edge-service

    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '21.5.0'
          npm: '10.8.1'
          cache: 'npm'
          cache-dependency-path: './edge-service/package-lock.json'

      - name: Remove package-lock.json
        run: rm -f package-lock.json

      - name: Install dependencies
        run: npm install --legacy-peer-deps
        continue-on-error: true

      - name: Build React app
        run: npm run build
        env:
          CI: false

      - name: Run tests
        run: npm test
        env:
          CI: false

      # Upload React build
      - name: Upload React build
        uses: actions/upload-artifact@v4
        with:
          name: react-build
          path: edge-service/dist

  deploy:
    needs: [java-build, react-build]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/master'  # Only deploy on master branch

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Install SSH key
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.EC2_SSH_KEY_PROD }}

      - name: Deploy to EC2
        env:
          EC2_HOST: ${{ secrets.HOST_DNS_PROD }}
          EC2_USERNAME: ${{ secrets.USERNAME_PROD }}
          TARGET_DIR: ${{ secrets.TARGET_DIR_PROD }}
        run: |
          # Disable strict host key checking
          mkdir -p ~/.ssh
          echo "StrictHostKeyChecking no" >> ~/.ssh/config

          # Create structured temp directory
          ssh $EC2_USERNAME@$EC2_HOST "
            rm -rf ~/deploy_temp
            mkdir -p ~/deploy_temp/.kube
            mkdir -p ~/deploy_temp/api-gateway
            mkdir -p ~/deploy_temp/edge-service
            mkdir -p ~/deploy_temp/keys
            mkdir -p ~/deploy_temp/discovery-server
            echo 'Temporary directory structure ready'
          "
          
          echo "Starting file copy..."
          
          # Copy all artifacts
          scp -v artifacts/java-artifacts/*.jar $EC2_USERNAME@$EC2_HOST:~/deploy_temp/api-gateway/
          scp -v artifacts/discovery-server-artifacts/*.jar $EC2_USERNAME@$EC2_HOST:~/deploy_temp/discovery-server/
          scp -v -r artifacts/react-build/* $EC2_USERNAME@$EC2_HOST:~/deploy_temp/edge-service/
          scp -v -r artifacts/kube-config/* $EC2_USERNAME@$EC2_HOST:~/deploy_temp/.kube/
          scp -v -r artifacts/keys-config/* $EC2_USERNAME@$EC2_HOST:~/deploy_temp/keys/
          scp -v artifacts/docker-compose/docker-compose.yml $EC2_USERNAME@$EC2_HOST:~/deploy_temp/

          # Deploy files with structured approach
          ssh $EC2_USERNAME@$EC2_HOST "
            echo 'Checking deploy_temp contents:'
            echo 'API Gateway files:'
            ls -la ~/deploy_temp/api-gateway/
            echo 'Discovery Server files:'
            ls -la ~/deploy_temp/discovery-server/
            echo 'Edge Service files:'
            ls -la ~/deploy_temp/edge-service/
            echo '.kube files:'
            ls -la ~/deploy_temp/.kube/
            echo 'keys files:'
            ls -la ~/deploy_temp/keys/
            echo 'Docker Compose file:'
            ls -la ~/deploy_temp/docker-compose.yml
            
            echo 'Moving files to target directories...'
            # Move entire directories
            sudo cp -r ~/deploy_temp/api-gateway/* /var/www/linqra/api-gateway/
            sudo cp -r ~/deploy_temp/discovery-server/* /var/www/linqra/discovery-server/
            sudo cp -r ~/deploy_temp/edge-service/* /var/www/linqra/edge-service/
            sudo cp -r ~/deploy_temp/.kube /var/www/linqra/
            sudo cp -r ~/deploy_temp/keys /var/www/linqra/
            sudo cp ~/deploy_temp/docker-compose.yml /var/www/linqra/

            # Set permissions
            sudo chown -R ubuntu:ubuntu /var/www/linqra/api-gateway/
            sudo chown -R ubuntu:ubuntu /var/www/linqra/discovery-server/
            sudo chown -R ubuntu:ubuntu /var/www/linqra/edge-service/
            sudo chown -R ubuntu:ubuntu /var/www/linqra/.kube/
            sudo chown -R ubuntu:ubuntu /var/www/linqra/keys/
            sudo chown ubuntu:ubuntu /var/www/linqra/docker-compose.yml
            sudo chmod -R 600 /var/www/linqra/keys/

            rm -rf ~/deploy_temp

            echo 'Restarting services...'
            sudo systemctl restart discovery-server || echo 'Failed to restart discovery-server'
            sleep 10  # Wait for discovery server to be ready
            sudo systemctl restart api-gateway || echo 'Failed to restart api-gateway'
            sudo nginx -t && sudo systemctl restart nginx
            
            echo 'Deployment completed'
          "

  dependency-review:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Dependency Review
        uses: actions/dependency-review-action@v4
        with:
          fail-on-severity: high 