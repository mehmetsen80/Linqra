version: '3.8'

networks:
  linqra-network:
    external: true

services:
  # postgres for Keycloak
  postgres-service:
    build:
      context: .
      dockerfile: ./.kube/postgres/Dockerfile.polaris
    container_name: postgres-service
    command: postgres -c "max_connections=200"
    restart: always
    ports:
      - "5432:5432"
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U $$POSTGRES_USER -d $$POSTGRES_DB" ]
      interval: 10s
      timeout: 3s
      retries: 3
    volumes:
      - ./.kube/postgres/data/:/var/lib/postgresql/pgdata
      - ./secrets:/app/secrets:ro
    environment:
      VAULT_MASTER_KEY: ${VAULT_MASTER_KEY}
      VAULT_ENVIRONMENT: ${VAULT_ENVIRONMENT:-ec2}
      VAULT_REQUIRED_VARS: POSTGRES_DB,POSTGRES_USER,POSTGRES_PASSWORD
    networks:
      - linqra-network

  # keycloak
  keycloak-service:
    build:
      context: .
      dockerfile: ./.kube/keycloak/Dockerfile.polaris
    container_name: keycloak-service
    environment:
      KC_DB: postgres
      KC_HTTP_ENABLED: true
      KC_HTTP_PORT: 8080
      KC_HTTP_RELATIVE_PATH: /keycloak

      KC_HOSTNAME: https://polaris.linqra.com/keycloak
      KC_HOSTNAME_STRICT: true
      KC_HOSTNAME_BACKCHANNEL_DYNAMIC: true

      # Proxy Settings (Keycloak 26+ uses proxy-headers)
      KC_PROXY_HEADERS: xforwarded

      KC_LOG_LEVEL: info
      KC_METRICS_ENABLED: true
      KC_HEALTH_ENABLED: true
      KC_FEATURES: admin

      # Legacy SPI overrides likely not needed with Hostname v2, but keeping minimal strictness
      KC_SPI_LOGIN_PROTOCOL_OPENID_CONNECT_LEGACY_IFRAME_COMPATIBLE: "true"
      KC_SPI_LOGIN_PROTOCOL_OPENID_CONNECT_SUPPRESS_LOGOUT_CONFIRMATION_SCREEN: "true"
      VAULT_MASTER_KEY: ${VAULT_MASTER_KEY}
      VAULT_ENVIRONMENT: ${VAULT_ENVIRONMENT:-ec2}
      VAULT_REQUIRED_VARS: POSTGRES_DB,POSTGRES_USER,POSTGRES_PASSWORD,KEYCLOAK_ADMIN,KEYCLOAK_ADMIN_PASSWORD

    command:
      - start
    volumes:
      - ./.kube/keycloak/data/import:/opt/keycloak/data/import
      - ./.kube/keycloak/data/export:/opt/keycloak/data/export
      - ./.kube/keycloak/themes:/opt/keycloak/themes
      - ./secrets:/app/secrets:ro
    depends_on:
      postgres-service:
        condition: service_healthy
    healthcheck:
      test: [ "CMD", "curl", "-f", "-H", "Host: localhost", "http://localhost:8080/health/ready" ]
      interval: 10s
      timeout: 3s
      retries: 3
    ports:
      - "8080:8080" # Exposed for VPC Peering access from EKS
    networks:
      - linqra-network
