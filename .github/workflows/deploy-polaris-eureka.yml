name: Deploy Eureka (Discovery Server) to Polaris

on:
  workflow_dispatch:

jobs:
  deploy-eureka:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      # Install Java 21 for vault-reader build (if needed locally, or just ensuring environment matches)
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Create secrets.json from GitHub secret
        env:
          SECRETS_JSON: ${{ secrets.SECRETS_JSON }}
        run: |
          mkdir -p secrets
          
          # Check if SECRETS_JSON secret is provided
          if [ -z "$SECRETS_JSON" ]; then
            echo "ERROR: SECRETS_JSON GitHub secret is not set"
            exit 1
          fi
          
          # Write the JSON secret to file
          echo "$SECRETS_JSON" > secrets/secrets.json
          echo "âœ… secrets.json created"

      - name: Make scripts executable
        run: chmod +x scripts/*.sh

      - name: Generate vault.encrypted
        env:
          VAULT_MASTER_KEY: ${{ secrets.VAULT_MASTER_KEY }}
        run: |
          # Require VAULT_MASTER_KEY to be set in GitHub secrets
          if [ -z "$VAULT_MASTER_KEY" ]; then
            echo "âŒ ERROR: VAULT_MASTER_KEY secret is not set"
            exit 1
          fi
          
          # Run bootstrap script to create vault
          export VAULT_ENVIRONMENT=ec2
          chmod +x scripts/bootstrap-vault.sh
          bash scripts/bootstrap-vault.sh secrets/secrets.json ec2
          
          # Verify vault file was created
          if [ ! -f secrets/vault.encrypted ]; then
            echo "ERROR: vault.encrypted was not created"
            exit 1
          fi
          
          echo "âœ… vault.encrypted created successfully"

      - name: Install SSH key
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.EC2_SSH_KEY_PROD }}

      - name: Deploy to Polaris EC2
        env:
          EC2_HOST: ${{ secrets.HOST_DNS_POLARIS }}
          EC2_USERNAME: ${{ secrets.USERNAME_PROD }}
          TARGET_DIR: ${{ secrets.TARGET_DIR_PROD }}
          VAULT_MASTER_KEY: ${{ secrets.VAULT_MASTER_KEY }}
        run: |
          # Disable strict host key checking
          mkdir -p ~/.ssh
          echo "StrictHostKeyChecking no" >> ~/.ssh/config

          echo "ðŸš€ Starting Deployment to $EC2_HOST..."

          # 1. Create directory structure
          ssh $EC2_USERNAME@$EC2_HOST "sudo mkdir -p $TARGET_DIR/.kube/eureka && sudo mkdir -p $TARGET_DIR/vault-reader && sudo mkdir -p $TARGET_DIR/secrets && sudo chown -R $EC2_USERNAME:$EC2_USERNAME $TARGET_DIR"
          
          # 2. Transfer files
          # Transfer common files (pom.xml, secrets, vault-reader, scripts)
          rsync -avz --exclude 'target/' --exclude 'node_modules/' \
            pom.xml vault-reader scripts \
            $EC2_USERNAME@$EC2_HOST:$TARGET_DIR/
            
          # Transfer secrets (Encrypted only)
          rsync -avz secrets/vault.encrypted $EC2_USERNAME@$EC2_HOST:$TARGET_DIR/secrets/
          
          # Transfer Eureka specific files
          rsync -avz .kube/eureka/ $EC2_USERNAME@$EC2_HOST:$TARGET_DIR/.kube/eureka/
          rsync -avz discovery-server/ $EC2_USERNAME@$EC2_HOST:$TARGET_DIR/discovery-server/
          
          # Transfer Docker Compose
          scp docker-compose-polaris-eureka.yml $EC2_USERNAME@$EC2_HOST:$TARGET_DIR/docker-compose-polaris-eureka.yml
          
          # 3. Deploy
            # Setup Permissions
            sudo chown -R $EC2_USERNAME $TARGET_DIR
            sudo chmod +x scripts/*.sh

            # Set Secrets Permissions
            sudo chmod 644 secrets/vault.encrypted

            # Export Master Key
            export VAULT_MASTER_KEY=$VAULT_MASTER_KEY
            export VAULT_ENVIRONMENT='ec2' && \
            docker compose -f docker-compose-polaris-eureka.yml down || true
            docker compose -f docker-compose-polaris-eureka.yml up -d --build"
