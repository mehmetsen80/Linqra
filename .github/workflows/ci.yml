name: Linqra CI
on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  java-app:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # Upload API Gateway source files
      - name: Upload API Gateway source
        uses: actions/upload-artifact@v4
        with:
          name: api-gateway-source
          path: |
            api-gateway/**
            !api-gateway/target/**
            !api-gateway/target/

      # Upload docker-compose.yml
      - name: Upload docker-compose file
        uses: actions/upload-artifact@v4
        with:
          name: docker-compose
          path: docker-compose-ec2.yml

      # Upload root pom.xml
      - name: Upload root pom file
        uses: actions/upload-artifact@v4
        with:
          name: root-pom
          path: pom.xml

      # Debug and upload .kube directory with hidden files
      - name: Debug .kube directory
        run: |
          echo "Checking .kube directory contents:"
          ls -la .kube/
          
      - name: Copy .kube to temporary directory
        run: |
          cp -r .kube kube-config
          
      - name: Upload kube directory
        uses: actions/upload-artifact@v4
        with:
          name: kube-config
          path: kube-config/**

      # Add this new step to upload keys directory
      - name: Upload keys directory
        uses: actions/upload-artifact@v4
        with:
          name: keys-config
          path: keys/
          if-no-files-found: error

      # Add this new step to upload scripts directory
      - name: Upload scripts directory
        uses: actions/upload-artifact@v4
        with:
          name: scripts-config
          path: scripts/
          if-no-files-found: error

      # Upload vault-reader source for building in Docker and CI vault generation
      - name: Upload vault-reader source
        uses: actions/upload-artifact@v4
        with:
          name: vault-reader-source
          path: |
            vault-reader/**
            !vault-reader/target/**
            !vault-reader/target/

  # Build vault-reader JAR (needed for Docker images that use vault system in any app)
  build-vault-reader:
    needs: java-app
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Build vault-reader JAR
        run: |
          cd vault-reader
          mvn clean package -DskipTests
          echo "✅ vault-reader.jar built successfully"
          ls -la target/vault-reader.jar

      - name: Upload vault-reader JAR
        uses: actions/upload-artifact@v4
        with:
          name: vault-reader-jar
          path: vault-reader/target/vault-reader.jar
          retention-days: 1

  # we build react here in the GitHub actions
  react-build:
    needs: java-app
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./edge-service
    steps:
      - uses: actions/checkout@v4

      - name: Create .env file
        run: |
          # Remove existing .env if present
          rm -f .env
          
          # Create new .env file
          cat <<'EOF' > .env
          NODE_ENV=production
          JWT_SECRET=${{ secrets.JWT_SECRET }}
          VITE_WS_URL=${{ secrets.VITE_WS_URL }}
          VITE_API_GATEWAY_URL=${{ secrets.VITE_API_GATEWAY_URL }}
          REACT_APP_KEYCLOAK_URL=${{ secrets.REACT_APP_KEYCLOAK_URL }}
          REACT_APP_KEYCLOAK_REALM=${{ secrets.REACT_APP_KEYCLOAK_REALM }}
          REACT_APP_KEYCLOAK_CLIENT_ID=${{ secrets.REACT_APP_KEYCLOAK_CLIENT_ID }}
          EOF
          
          # Verify .env was created
          if [ -f .env ]; then
            echo "✅ .env file created successfully"
            echo "File size: $(wc -c < .env) bytes"
          else
            echo "❌ Failed to create .env file"
            exit 1
          fi
        working-directory: ./edge-service

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '21.5.0'

      - name: Upgrade npm
        run: npm install -g npm@10.8.1

      - name: Remove package-lock.json
        run: rm -f package-lock.json

      - name: Install dependencies
        run: npm install --legacy-peer-deps
        continue-on-error: true

      - name: Build React app
        run: npm run build
        env:
          CI: false

      - name: Run tests
        run: npm test
        env:
          CI: false

      # Upload React build
      - name: Upload React build
        uses: actions/upload-artifact@v4
        with:
          name: react-build
          path: edge-service/dist

  generate-vault:
    needs: java-app
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/master'
    steps:
      - uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Download vault-reader source
        uses: actions/download-artifact@v4
        with:
          name: vault-reader-source
          path: vault-reader

      - name: Download scripts
        uses: actions/download-artifact@v4
        with:
          name: scripts-config
          path: scripts

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Build vault-reader
        run: |
          cd vault-reader
          mvn clean package -DskipTests

      - name: Create secrets.json from GitHub secret
        env:
          VAULT_MASTER_KEY: ${{ secrets.VAULT_MASTER_KEY }}
          SECRETS_JSON: ${{ secrets.SECRETS_JSON }}
        run: |
          mkdir -p secrets
          
          # Require VAULT_MASTER_KEY to be set in GitHub secrets
          if [ -z "$VAULT_MASTER_KEY" ]; then
            echo "❌ ERROR: VAULT_MASTER_KEY secret is not set in GitHub repository secrets"
            echo ""
            echo "Please add VAULT_MASTER_KEY to your GitHub repository secrets:"
            echo "1. Go to: Settings → Secrets and variables → Actions"
            echo "2. Click 'New repository secret'"
            echo "3. Name: VAULT_MASTER_KEY"
            echo "4. Value: Generate a key with: openssl rand -base64 32"
            exit 1
          fi
          
          # Check if SECRETS_JSON secret is provided
          if [ -z "$SECRETS_JSON" ]; then
            echo "ERROR: SECRETS_JSON GitHub secret is not set"
            echo "Please add your complete secrets.json file content (with 'ec2' environment) as a GitHub secret named 'SECRETS_JSON'"
            echo ""
            echo "The JSON should have this structure:"
            echo '{'
            echo '  "ec2": {'
            echo '    "postgres.db": "...",'
            echo '    "postgres.user": "...",'
            echo '    ...'
            echo '  }'
            echo '}'
            exit 1
          fi
          
          # Write the JSON secret to file
          echo "$SECRETS_JSON" > secrets/secrets.json
          
          # Validate JSON structure
          if ! jq . secrets/secrets.json > /dev/null 2>&1; then
            echo "ERROR: Invalid JSON structure in SECRETS_JSON secret"
            echo "Please ensure the JSON is valid and properly formatted"
            exit 1
          fi
          
          # Verify ec2 environment exists in JSON
          if ! jq -e 'has("ec2")' secrets/secrets.json > /dev/null 2>&1; then
            echo "ERROR: 'ec2' environment not found in SECRETS_JSON"
            echo "Available environments:"
            jq -r 'keys[]' secrets/secrets.json | sed 's/^/  - /'
            echo ""
            echo "The JSON must contain an 'ec2' environment with all required secrets"
            exit 1
          fi
          
          echo "✅ secrets.json created and validated"

      - name: Generate vault.encrypted
        env:
          VAULT_MASTER_KEY: ${{ secrets.VAULT_MASTER_KEY }}
        run: |
          # Require VAULT_MASTER_KEY to be set in GitHub secrets
          if [ -z "$VAULT_MASTER_KEY" ]; then
            echo "❌ ERROR: VAULT_MASTER_KEY secret is not set in GitHub repository secrets"
            echo ""
            echo "Please add VAULT_MASTER_KEY to your GitHub repository secrets:"
            echo "1. Go to: Settings → Secrets and variables → Actions"
            echo "2. Click 'New repository secret'"
            echo "3. Name: VAULT_MASTER_KEY"
            echo "4. Value: Generate a key with: openssl rand -base64 32"
            echo ""
            echo "If this is your first run, you can generate a key:"
            echo "  openssl rand -base64 32"
            exit 1
          fi
          
          # Run bootstrap script to create vault
          export VAULT_ENVIRONMENT=ec2
          chmod +x scripts/bootstrap-vault.sh
          bash scripts/bootstrap-vault.sh secrets/secrets.json ec2
          
          # Verify vault file was created
          if [ ! -f secrets/vault.encrypted ]; then
            echo "ERROR: vault.encrypted was not created"
            exit 1
          fi
          
          echo "✅ vault.encrypted created successfully"

      - name: Upload vault file
        uses: actions/upload-artifact@v4
        with:
          name: vault-encrypted
          path: secrets/vault.encrypted
          retention-days: 1

  deploy:
    needs: [java-app, react-build, generate-vault, build-vault-reader]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/master'

    steps:
      - name: Download all of the artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
      - name: Install SSH key
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.EC2_SSH_KEY_PROD }}
      - name: Deploy to EC2
        env:
          EC2_HOST: ${{ secrets.HOST_DNS_PROD }}
          EC2_USERNAME: ${{ secrets.USERNAME_PROD }}
          TARGET_DIR: ${{ secrets.TARGET_DIR_PROD }}
          VAULT_MASTER_KEY: ${{ secrets.VAULT_MASTER_KEY }}
        run: |
          # Disable strict host key checking
          mkdir -p ~/.ssh
          echo "StrictHostKeyChecking no" >> ~/.ssh/config

          # Rsync main directories (only changed/new files, with sudo on remote)
          rsync -avz --delete --rsync-path="sudo rsync" artifacts/api-gateway-source/ $EC2_USERNAME@$EC2_HOST:/var/www/linqra/api-gateway/
          rsync -avz --delete --rsync-path="sudo rsync" artifacts/react-build/ $EC2_USERNAME@$EC2_HOST:/var/www/linqra/edge-service/

          # Use scp for sensitive or always-fresh files
          scp -v artifacts/docker-compose/docker-compose-ec2.yml $EC2_USERNAME@$EC2_HOST:/var/www/linqra/docker-compose.yml
          scp -v artifacts/root-pom/pom.xml $EC2_USERNAME@$EC2_HOST:/var/www/linqra/pom.xml

          # Upload vault-reader source
          if [ -d "artifacts/vault-reader-source" ]; then
            rsync -avz --delete --rsync-path="sudo rsync" artifacts/vault-reader-source/ $EC2_USERNAME@$EC2_HOST:/var/www/linqra/vault-reader/
          fi

          # Upload generated vault.encrypted file
          if [ -f "artifacts/vault-encrypted/vault.encrypted" ]; then
            echo "Uploading vault.encrypted file to EC2..."
            scp -v artifacts/vault-encrypted/vault.encrypted $EC2_USERNAME@$EC2_HOST:/tmp/vault.encrypted
          else
            echo "WARNING: vault.encrypted file not found in artifacts"
          fi

          # Upload vault-reader JAR to EC2
          if [ -f "artifacts/vault-reader-jar/vault-reader.jar" ]; then
            echo "Uploading vault-reader.jar to EC2..."
            ssh $EC2_USERNAME@$EC2_HOST "sudo mkdir -p /var/www/linqra/vault-reader/target"
            scp -v artifacts/vault-reader-jar/vault-reader.jar $EC2_USERNAME@$EC2_HOST:/tmp/vault-reader.jar
            ssh $EC2_USERNAME@$EC2_HOST "sudo mv /tmp/vault-reader.jar /var/www/linqra/vault-reader/target/vault-reader.jar && sudo chown ubuntu:ubuntu /var/www/linqra/vault-reader/target/vault-reader.jar"
            echo "✅ vault-reader.jar deployed to EC2"
          else
            echo "ERROR: vault-reader.jar not found in artifacts"
            exit 1
          fi

          # .kube, keys, and scripts (if needed, use scp or rsync as appropriate)
          # CRITICAL: Protect all data directories from deletion during rsync
          if [ -d "artifacts/kube-config" ]; then
            rsync -avz --delete --rsync-path="sudo rsync" artifacts/kube-config/ $EC2_USERNAME@$EC2_HOST:/var/www/linqra/.kube/
          fi
          if [ -d "artifacts/keys-config" ]; then
            rsync -avz --delete --rsync-path="sudo rsync" artifacts/keys-config/ $EC2_USERNAME@$EC2_HOST:/var/www/linqra/keys/
          fi
          if [ -d "artifacts/scripts-config" ]; then
            rsync -avz --delete --rsync-path="sudo rsync" artifacts/scripts-config/ $EC2_USERNAME@$EC2_HOST:/var/www/linqra/scripts/
          fi

          echo "About to run SSH block"
          ssh $EC2_USERNAME@$EC2_HOST "
            # Set basic permissions
            sudo chown -R ubuntu:ubuntu /var/www/linqra
            sudo chmod -R 600 /var/www/linqra/keys/* || echo 'No keys to set permissions for'
            sudo find /var/www/linqra/keys -type d -exec chmod 755 {} \;
            sudo find /var/www/linqra/keys -type f ! -name 'mongo-keyfile' -exec chmod 600 {} \;

            # Ensure secrets directory exists with proper permissions
            # NOTE: Must be 755/644 so Docker containers (running as different UIDs) can read vault
            echo 'Setting up secrets directory for vault'
            if [ ! -d /var/www/linqra/secrets ]; then
              sudo mkdir -p /var/www/linqra/secrets
            fi
            sudo chown ubuntu:ubuntu /var/www/linqra/secrets
            sudo chmod 755 /var/www/linqra/secrets
            
            # Copy vault.encrypted from /tmp if it was uploaded
            if [ -f /tmp/vault.encrypted ]; then
              echo 'Copying vault.encrypted from /tmp to secrets directory'
              sudo mv /tmp/vault.encrypted /var/www/linqra/secrets/vault.encrypted
              sudo chown ubuntu:ubuntu /var/www/linqra/secrets/vault.encrypted
              sudo chmod 644 /var/www/linqra/secrets/vault.encrypted
              echo '✅ vault.encrypted file deployed and permissions set'
            elif [ -f /var/www/linqra/secrets/vault.encrypted ]; then
              echo 'vault.encrypted already exists, preserving existing file'
              sudo chown ubuntu:ubuntu /var/www/linqra/secrets/vault.encrypted
              sudo chmod 644 /var/www/linqra/secrets/vault.encrypted
            else
              echo 'WARNING: vault.encrypted file not found'
              echo 'This should have been generated in CI/CD pipeline'
              exit 1
            fi

              # Create global .env file at project root (not stored in repo)
              echo "VAULT_MASTER_KEY=${{ secrets.VAULT_MASTER_KEY }}" > /var/www/linqra/.env
              echo "VAULT_ENVIRONMENT=ec2" >> /var/www/linqra/.env
              sudo chmod 600 /var/www/linqra/.env
              
              # Create edge-service .env on EC2 (not stored in repo)
              if [ ! -d /var/www/linqra/edge-service ]; then echo 'edge-service directory not found at /var/www/linqra/edge-service'; exit 1; fi

              echo "NODE_ENV=production" >> /var/www/linqra/edge-service/.env
              echo "JWT_SECRET=${{ secrets.JWT_SECRET }}" >> /var/www/linqra/edge-service/.env
              echo "VITE_WS_URL=${{ secrets.VITE_WS_URL }}" >> /var/www/linqra/edge-service/.env
              echo "VITE_API_GATEWAY_URL=${{ secrets.VITE_API_GATEWAY_URL }}" >> /var/www/linqra/edge-service/.env
              echo "REACT_APP_KEYCLOAK_URL=${{ secrets.REACT_APP_KEYCLOAK_URL }}" >> /var/www/linqra/edge-service/.env
              echo "REACT_APP_KEYCLOAK_REALM=${{ secrets.REACT_APP_KEYCLOAK_REALM }}" >> /var/www/linqra/edge-service/.env
              echo "REACT_APP_KEYCLOAK_CLIENT_ID=${{ secrets.REACT_APP_KEYCLOAK_CLIENT_ID }}" >> /var/www/linqra/edge-service/.env
              sudo chmod 600 /var/www/linqra/edge-service/.env


            # Ensure scripts are executable
            sudo chmod +x /var/www/linqra/scripts/*.sh

            # Move to the deployment directory
            cd /var/www/linqra

            # Stop running containers
            echo 'Stopping running containers'
            sudo docker compose stop

            # Prune unused images and containers (but preserve volumes and networks)
            echo 'Pruning unused images and containers'
            sudo docker image prune -a -f
            sudo docker container prune -f

            # Check disk usage
            echo 'Checking disk usage'
            df -hT

            # Ensure the Docker network exists
            echo 'Ensuring the Docker network exists'
            sudo docker network ls | grep -q linqra-network || sudo docker network create linqra-network

            # Load VAULT_MASTER_KEY and VAULT_ENVIRONMENT from global .env file
            echo 'Loading VAULT_MASTER_KEY and VAULT_ENVIRONMENT from .env file'
            if [ -f /var/www/linqra/.env ]; then
              set -a  # Automatically export all variables
              source /var/www/linqra/.env
              set +a  # Stop automatically exporting
              echo '✓ Loaded variables from .env file'
            else
              echo 'ERROR: /var/www/linqra/.env file not found'
              echo 'This file should have been created in the deployment step above'
              exit 1
            fi
            
            if [ -z \"\$VAULT_MASTER_KEY\" ]; then
              echo 'ERROR: VAULT_MASTER_KEY not set in .env file'
              exit 1
            fi
            
            if [ -z \"\$VAULT_ENVIRONMENT\" ]; then
              echo 'WARNING: VAULT_ENVIRONMENT not set in .env, defaulting to ec2'
              export VAULT_ENVIRONMENT=ec2
            fi

            # Build and start containers
            # docker-compose automatically loads .env file from the directory where it's run
            echo 'Building and starting containers'
            sudo -E docker compose -f docker-compose.yml -p linqra up -d --build

            # Check if containers are running
            echo 'Checking if containers are running'
            docker ps
          "

      - name: Post Install SSH Key
        if: always()
        run: |
          if [ -n "${SSH_AUTH_SOCK:-}" ]; then
            eval "$(ssh-agent -k)" || true
          fi

  dependency-review:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Dependency Review
        uses: actions/dependency-review-action@v4
        with:
          fail-on-severity: high 